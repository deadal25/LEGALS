<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Status Tanda Tangan Perjanjian</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f4f6f9;
      color: #333;
      padding: 20px;
    }
    h1 { color: #1a73e8; margin-bottom: 10px; }
    #lastUpdate { font-size: 13px; color: #555; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }
    th { background: #1a73e8; color: white; font-size: 13px; }
    tr:hover { background: #f1f3f4; }
    .done { color: green; font-weight: bold; }
    .pending { color: orange; font-weight: bold; }
    .aksi-cell {
      display: flex; flex-direction: column; gap: 4px; align-items: center;
    }
    .btn {
      padding: 6px 10px; border: none; border-radius: 6px;
      cursor: pointer; font-size: 12px; color: white; min-width: 90px;
    }
    .btn-email { background: #1a73e8; }
    .btn-wa { background: #25D366; }
  </style>
</head>
<body>
  <h1>ðŸ“„ Status Tanda Tangan Dokumen Perjanjian</h1>
  <div id="lastUpdate">Terakhir diperbarui: -</div>

  <table id="statusTable">
    <thead>
      <tr>
        <th rowspan="2">No. Perjanjian</th>
        <th rowspan="2">Nama Perusahaan</th>
        <th rowspan="2">Nama Pembeli</th>
        <th rowspan="2">Email Pembeli</th>
        <th rowspan="2">No. HP Pembeli</th>
        <th colspan="2">Pembeli</th>
        <th colspan="2">Sales</th>
        <th colspan="2">ADH</th>
        <th colspan="2">Penjual</th>
        <th rowspan="2">Aksi</th>
      </tr>
      <tr>
        <th>Waktu</th><th>Status</th>
        <th>Waktu</th><th>Status</th>
        <th>Waktu</th><th>Status</th>
        <th>Waktu</th><th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="13">Memuat data...</td></tr>
    </tbody>
  </table>

  <script>
    const apiUrl =
      "https://script.google.com/macros/s/AKfycbzcusEShXczUukd2qaW5KwvWervH6PSJ3sLCTND2sZc7BiJM6foE_jfd72REfKMygIK6Q/exec?mode=status";
    const notifyUrl =
      "https://script.google.com/macros/s/AKfycbzcusEShXczUukd2qaW5KwvWervH6PSJ3sLCTND2sZc7BiJM6foE_jfd72REfKMygIK6Q/exec?mode=notify";

    // âœ… Format waktu (jaga tetap seperti di Spreadsheet)
    function formatWaktu(str) {
      if (!str || str === "-" || str === "undefined") return "-";
      if (/^\d{2}\/\d{2}\/\d{4}/.test(str)) return str; // Sudah format spreadsheet
      const d = new Date(str);
      if (!isNaN(d)) {
        const tanggal = d.toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
        const waktu = d.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
        return `${tanggal} ${waktu}`;
      }
      return str;
    }

    // âœ… Format status agar tidak undefined
    function makeStatus(status) {
      if (!status || status === "-" || status === "undefined") {
        return `<span class="pending">Belum Ada Tanda Tangan</span>`;
      }
      const cls = status.includes("âœ…") ? "done" : "pending";
      return `<span class="${cls}">${status}</span>`;
    }

    // âœ… Tombol aksi
    function makeAksiButtons(row) {
      const noperjanjian = row.noperjanjian;
      const email = row.email_pembeli;
      const nohp = row.nohp_pembeli;
      return `
        <div class="aksi-cell">
          <button class="btn btn-email" onclick="kirimEmail('pembeli','${noperjanjian}')">ðŸ“§ Email Pembeli</button>
          ${nohp ? `<button class="btn btn-wa" onclick="kirimWA('${nohp}','${noperjanjian}')">ðŸ“± WhatsApp</button>` : ""}
          <button class="btn btn-email" onclick="kirimEmail('sales','${noperjanjian}')">ðŸ“§ Email Sales</button>
          <button class="btn btn-email" onclick="kirimEmail('adh','${noperjanjian}')">ðŸ“§ Email ADH</button>
          <button class="btn btn-email" onclick="kirimEmail('penjual','${noperjanjian}')">ðŸ“§ Email Penjual</button>
        </div>
      `;
    }

    // âœ… Muat data status dari Apps Script
    function loadStatusData() {
      fetch(apiUrl)
        .then((res) => res.json())
        .then((data) => {
          const tbody = document.querySelector("#statusTable tbody");
          tbody.innerHTML = "";

          data.forEach((row) => {
            // pastikan semua field diset, biar tidak geser
            const safe = {
              noperjanjian: row.noperjanjian || "-",
              nama_perusahaan: row.nama_perusahaan || "-",
              nama_pembeli: row.nama_pembeli || "-",
              email_pembeli: row.email_pembeli || "-",
              nohp_pembeli: row.nohp_pembeli || "-",

              waktu_pembeli: row.waktu_pembeli || "-",
              status_pembeli: row.status_pembeli || "Belum Ada Tanda Tangan",

              waktu_sales: row.waktu_sales || "-",
              status_sales: row.status_sales || "Belum Ada Tanda Tangan",

              waktu_adh: row.waktu_adh || "-",
              status_adh: row.status_adh || "Belum Ada Tanda Tangan",

              waktu_penjual: row.waktu_penjual || "-",
              status_penjual: row.status_penjual || "Belum Ada Tanda Tangan",
            };

            // buat baris tabel
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${safe.noperjanjian}</td>
              <td>${safe.nama_perusahaan}</td>
              <td>${safe.nama_pembeli}</td>
              <td>${safe.email_pembeli}</td>
              <td>${safe.nohp_pembeli}</td>

              <td>${formatWaktu(safe.waktu_pembeli)}</td>
              <td>${makeStatus(safe.status_pembeli)}</td>

              <td>${formatWaktu(safe.waktu_sales)}</td>
              <td>${makeStatus(safe.status_sales)}</td>

              <td>${formatWaktu(safe.waktu_adh)}</td>
              <td>${makeStatus(safe.status_adh)}</td>

              <td>${formatWaktu(safe.waktu_penjual)}</td>
              <td>${makeStatus(safe.status_penjual)}</td>

              <td>${makeAksiButtons(row)}</td>
            `;
            tbody.appendChild(tr);
          });

          document.getElementById("lastUpdate").textContent =
            "Terakhir diperbarui: " +
            new Date().toLocaleTimeString("id-ID", { hour12: false });
        })
        .catch((err) => {
          document.querySelector("#statusTable tbody").innerHTML = `
            <tr><td colspan="13" style="color:red;">Gagal memuat data: ${err.message}</td></tr>
          `;
        });
    }

    // âœ… Kirim email pengingat
    function kirimEmail(role, noperjanjian) {
      fetch(`${notifyUrl}&type=email&role=${role}&noperjanjian=${noperjanjian}`)
        .then((res) => res.text())
        .then(() =>
          alert(`ðŸ“§ Pengingat email untuk ${role.toUpperCase()} dikirim (No. Perjanjian: ${noperjanjian})`)
        )
        .catch((err) => alert("Gagal kirim email: " + err.message));
    }

    // âœ… Kirim pengingat via WA
    function kirimWA(nohp, noperjanjian) {
      const pesan = encodeURIComponent(
        `Halo! Ini pengingat untuk menandatangani dokumen perjanjian nomor ${noperjanjian}. Mohon segera ditandatangani.`
      );
      window.open(`https://wa.me/${nohp}?text=${pesan}`, "_blank");
    }

    loadStatusData();
    setInterval(loadStatusData, 15000);
  </script>
</body>
</html>
